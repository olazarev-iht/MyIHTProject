@page "/dynDataModificationCNC"

@using BlazorServerHost.Features.HeightControlFeature.Services.CNC
@using SharedComponents.Models.APCHardware
@inject DynDataModificationCNCDataProvider dynDataModificationCNCDataProvider
@implements IDisposable
<MudText Typo="Typo.h4">Dynamic Params Modification (CNC)</MudText>


<style>
.device_tabcell {
    width: 87px;
    height:50px;
    text-align: center;
}

.tabcell {
    width: 75px;
    height:50px;
    text-align: center;
}

table#controlPanel td  {
    border: 1px solid #e0e0e0;
}

.SelectedParamsType {
    background-color:aquamarine;
}

.UnselectedParamsType {
    background-color:aliceblue;
}

.SelectedDeviceNum {
    background-color:mistyrose;
}

.UnselectedDeviceNum {
    background-color:aliceblue;
}

.NotInUseDeviceNum {
    background-color:lightgrey;
}

.flex-container {
  display: flex;
  flex-direction: row;
}

.flex-item-left {
  float:left;
  flex: 50%;
}

.flex-item-right {
  flex: 50%;
}


</style>

@if (dynDataModificationCNCDataProvider != null)
{
    paramHeatO2 = dynDataModificationCNCDataProvider._paramHeatO2;
    paramFuelGas = dynDataModificationCNCDataProvider._paramFuelGas;

    if(dynDataModificationCNCDataProvider.CurrentParamsType == "Ignition")
    {
        paramFlameAdjust = dynDataModificationCNCDataProvider._paramFlameAdjust;
        _cutO2Visible = NONE_DISPLAY_CLASS;
        _flameAdjustVisible = VISIBLE_CLASS;
    }
    else if(dynDataModificationCNCDataProvider.CurrentParamsType != "PreHeat" 
            && dynDataModificationCNCDataProvider.CurrentParamsType != "Heat")
    {
        paramCutO2 = dynDataModificationCNCDataProvider._paramCutO2;
        _flameAdjustVisible = NONE_DISPLAY_CLASS;
        _cutO2Visible = VISIBLE_CLASS;
    }
    else
    {
        _flameAdjustVisible = NONE_DISPLAY_CLASS;
        _cutO2Visible = INVISIBLE_CLASS;
    }

<div class="flex-container" >
    <table id="controlPanel" class="tablemobile" width="550px">
        <tr>
            <td>
                <div class="flex-item-left">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(1)"
            @onclick="@(()=>SetDeviceNum(1))">1</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(2)"
            @onclick="@(()=>SetDeviceNum(2))">2</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(3)"
            @onclick="@(()=>SetDeviceNum(3))">3</MudTd>
                        </tr>
                    </table>
                 </div>
                 <div class="flex-item-right">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(4)"
            @onclick="@(()=>SetDeviceNum(4))">4</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(5)"
            @onclick="@(()=>SetDeviceNum(5))">5</MudTd>
            <td>&nbsp;=&nbsp;</td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <div class="flex-item-left">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(6)"
            @onclick="@(()=>SetDeviceNum(6))">6</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(7)"
            @onclick="@(()=>SetDeviceNum(7))">7</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(8)"
            @onclick="@(()=>SetDeviceNum(8))">8</MudTd>
                        </tr>
                    </table>
                </div>
                <div class="flex-item-right">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(9)"
            @onclick="@(()=>SetDeviceNum(9))">9</MudTd>
            <MudTd Style="font-weight:bold;" Class="@GetDeviceNumClass(10)"
            @onclick="@(()=>SetDeviceNum(10))">10</MudTd>
            <td>&nbsp;E&nbsp;</td>
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
        <tr>
            <td>
                <div class="flex-item-left">
                <table width="270px" >
                    <tr>
                        <td>
                            <MudSlider @ontouchend="@(()=>UpdateDynParam(@paramHeatO2))" @onmouseup="@(()=>UpdateDynParam(@paramHeatO2))"
                            @bind-Value="@paramHeatO2.DynParams.Value" 
                            Min="@paramHeatO2.DynParams.ConstParams.Min" 
                            Max="@paramHeatO2.DynParams.ConstParams.Max"
                            Step="@paramHeatO2.DynParams.ConstParams.Step" 
                            Color="Color.Info">Flame (H-O): @paramHeatO2.DynParams.Value.ToString()
                            </MudSlider>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <MudSlider @ontouchend="@(()=>UpdateDynParam(@paramFuelGas))" @onmouseup="@(()=>UpdateDynParam(@paramFuelGas))"
                            @bind-Value="@paramFuelGas.DynParams.Value" 
                            Min="@paramFuelGas.DynParams.ConstParams.Min" 
                            Max="@paramFuelGas.DynParams.ConstParams.Max"
                            Step="@paramFuelGas.DynParams.ConstParams.Step" 
                            Color="Color.Info">F - G: @paramFuelGas.DynParams.Value.ToString()
                            </MudSlider>
                        </td>
                    </tr>
                    <tr>
                        <td>                            
                            <MudSlider Class="@_cutO2Visible" @ontouchend="@(()=>UpdateDynParam(@paramCutO2))" @onmouseup="@(()=>UpdateDynParam(@paramCutO2))"                
                            @bind-Value="@paramCutO2.DynParams.Value" 
                            Min="@paramCutO2.DynParams.ConstParams.Min" 
                            Max="@paramCutO2.DynParams.ConstParams.Max"
                            Step="@paramCutO2.DynParams.ConstParams.Step" 
                            Color="Color.Info">C - O: @paramCutO2.DynParams.Value.ToString()
                            </MudSlider>
                           
                            <MudSlider Class="@_flameAdjustVisible" @ontouchend="@(()=>UpdateDynParam(@paramFlameAdjust))" @onmouseup="@(()=>UpdateDynParam(@paramFlameAdjust))"
                            @bind-Value="@paramFlameAdjust.DynParams.Value" 
                            Min="@paramFlameAdjust.DynParams.ConstParams.Min" 
                            Max="@paramFlameAdjust.DynParams.ConstParams.Max"
                            Step="@paramFlameAdjust.DynParams.ConstParams.Step" 
                            Color="Color.Info">Flame Adjust: @paramFlameAdjust.DynParams.Value.ToString()
                            </MudSlider>
                        </td>
                    </tr>
                </table>
                </div>
                <div class="flex-item-right">
                    <table>
                        <tr>
                            <td> SP </td>
            <td colspan="2">
                <table width="100%">
                    <tr>
                        <td width="50%">Calib1</td>
                        <td width="50%">Calib2</td>
                    </tr>
                    <tr>
                        <td rowspan="2">Empty</td>
                        <td>
                            <table>
                                <tr><td>img1</td></tr>
                                <tr><td>img2</td></tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
                        </tr>
                    </table>
                </div>
            </td>                      
        </tr>
        <tr>
            <td>
                <div class="flex-item-left">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold; width:17%;" Class="@GetParamsTypeClass("Ignition")"
            @onclick="@(()=>SetParamsType("Ignition"))">Ignition</MudTd>
            <MudTd Style="font-weight:bold; width:17%" Class="@GetParamsTypeClass("PreHeat")"
            @onclick="@(()=>SetParamsType("PreHeat"))">Preheat</MudTd>
            <MudTd Style="font-weight:bold; width:17%" Class="@GetParamsTypeClass("Pierce")"
            @onclick="@(()=>SetParamsType("Pierce"))">Piercing</MudTd>
                        </tr>
                    </table>
                 </div>
                 <div class="flex-item-right">
                    <table>
                        <tr>
            <MudTd Style="font-weight:bold; width:17%" Class="@GetParamsTypeClass("Cut")"
            @onclick="@(()=>SetParamsType("Cut"))">Cutting</MudTd>
            <MudTd Style="font-weight:bold; width:17%" Class="@GetParamsTypeClass("Heat")"
            @onclick="@(()=>SetParamsType("Heat"))">Heating</MudTd>
            <td>&nbsp;</td>   
                        </tr>
                    </table>
                </div>
            </td>
        </tr>
    </table>
</div>

}
@code {

    public event EventHandler? DynamicAPCParamsClientChanged;

    private ParameterDataModel paramHeatO2 = new();
    private ParameterDataModel paramFuelGas = new();
    private ParameterDataModel paramCutO2 = new();
    private ParameterDataModel paramFlameAdjust = new();

    private string _cutO2Visible;
    private string _flameAdjustVisible;
    private string INVISIBLE_CLASS = "invisible";
    private string VISIBLE_CLASS = "visible";

    private string NONE_DISPLAY_CLASS = "d-none";
    private string DISPLAY_CLASS = "d-block";

    protected override void OnInitialized()
    {
        dynDataModificationCNCDataProvider.DynamicAPCParamsDataChanged += DynamicAPCParamsOnDynamicAPCParamsDataChanged;
        this.DynamicAPCParamsClientChanged += dynDataModificationCNCDataProvider.dynamicParamsDysplay_DynamicAPCParamsClientChanged;

        base.OnInitialized();
    }

    private async void SetParamsType(string paramsType)
    {
        dynDataModificationCNCDataProvider.CurrentParamsType = paramsType;

        await dynDataModificationCNCDataProvider.RefreshDynamicDataModelToDisplayAsync();

        await InvokeAsync(StateHasChanged);
    }

    private async void SetDeviceNum(int deviceNum)
    {
        if (deviceNum <= dynDataModificationCNCDataProvider.APCDevicesCount)
        {
            dynDataModificationCNCDataProvider.CurrentDeviceNumber = deviceNum;

            await dynDataModificationCNCDataProvider.RefreshDynamicDataModelToDisplayAsync();

            await InvokeAsync(StateHasChanged);
        }
    }

    private string GetParamsTypeClass(string selectedType)
    {
        if (selectedType.ToLower() == dynDataModificationCNCDataProvider.CurrentParamsType.ToLower())
            return "SelectedParamsType tabcell";
        return "UnselectedParamsType tabcell";
    }

    private string GetDeviceNumClass(int selectedNum)
    {
        var cssClass = "NotInUseDeviceNum device_tabcell";

        if (selectedNum == dynDataModificationCNCDataProvider.CurrentDeviceNumber){
            cssClass = "SelectedDeviceNum device_tabcell";
        }
        else if(selectedNum <= dynDataModificationCNCDataProvider.APCDevicesCount){
            cssClass = "UnselectedDeviceNum device_tabcell";
        }

        return cssClass;
    }

    private void UpdateDynParam(ParameterDataModel parameterData)
    {
        OnParamChanged(parameterData);
    }

    private async void DynamicAPCParamsOnDynamicAPCParamsDataChanged(object? sender, EventArgs e)
    {
        await InvokeAsync(StateHasChanged);
    }

    public void Dispose()
    {
        dynDataModificationCNCDataProvider.DynamicAPCParamsDataChanged -= DynamicAPCParamsOnDynamicAPCParamsDataChanged;
        this.DynamicAPCParamsClientChanged -= dynDataModificationCNCDataProvider.dynamicParamsDysplay_DynamicAPCParamsClientChanged;
    }

    private void ParamSelected1(ChangeEventArgs args)
    {
        //dynDataModificationCNCDataProvider._paramHeatO2.DynParams.Value = args.Value;
        //OnParamChanged();
    }

    private void OnParamChanged(object eventParam)
    {
        this.DynamicAPCParamsClientChanged?.Invoke(eventParam, EventArgs.Empty);
    }

}